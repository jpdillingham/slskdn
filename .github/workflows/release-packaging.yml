name: Update Packaging

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-nix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Release Info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG=$(curl -s https://api.github.com/repos/snapetech/slskdn/releases/latest | jq -r .tag_name)
          else
            TAG=${{ github.event.release.tag_name }}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Calculate Hashes
        id: hashes
        run: |
          TAG=${{ steps.release.outputs.tag }}
          BASE="https://github.com/snapetech/slskdn/releases/download/${TAG}"
          
          calc_hash() {
            curl -sL -o tmp.zip "$1" && sha256sum tmp.zip | awk '{print $1}' && rm -f tmp.zip
          }

          echo "linux_x64=$(calc_hash ${BASE}/slskdn-${TAG}-linux-x64.zip)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(calc_hash ${BASE}/slskdn-${TAG}-linux-arm64.zip)" >> $GITHUB_OUTPUT
          echo "osx_x64=$(calc_hash ${BASE}/slskdn-${TAG}-osx-x64.zip)" >> $GITHUB_OUTPUT
          echo "osx_arm64=$(calc_hash ${BASE}/slskdn-${TAG}-osx-arm64.zip)" >> $GITHUB_OUTPUT
          echo "win_x64=$(calc_hash ${BASE}/slskdn-${TAG}-win-x64.zip)" >> $GITHUB_OUTPUT

      - name: Update flake.nix
        run: |
          chmod +x packaging/scripts/update-nix.sh
          packaging/scripts/update-nix.sh \
            "${{ steps.release.outputs.tag }}" \
            "${{ steps.hashes.outputs.linux_x64 }}" \
            "${{ steps.hashes.outputs.linux_arm64 }}" \
            "${{ steps.hashes.outputs.osx_x64 }}" \
            "${{ steps.hashes.outputs.osx_arm64 }}"

      - name: Commit Nix Update
        run: |
          git config user.name "slskdn-bot"
          git config user.email "slskdn@proton.me"
          git add flake.nix
          git commit -m "chore: Update flake.nix to ${{ steps.release.outputs.tag }}" || echo "No changes"
          git push

  update-flatpak-snap-choco:
    runs-on: ubuntu-latest
    needs: update-nix
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
      
      - name: Get Release Info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG=$(curl -s https://api.github.com/repos/snapetech/slskdn/releases/latest | jq -r .tag_name)
          else
            TAG=${{ github.event.release.tag_name }}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Calculate Hashes
        id: hashes
        run: |
          TAG=${{ steps.release.outputs.tag }}
          BASE="https://github.com/snapetech/slskdn/releases/download/${TAG}"
          
          calc_hash() {
            curl -sL -o tmp.zip "$1" && sha256sum tmp.zip | awk '{print $1}' && rm -f tmp.zip
          }
          
          echo "linux_x64=$(calc_hash ${BASE}/slskdn-${TAG}-linux-x64.zip)" >> $GITHUB_OUTPUT
          echo "win_x64=$(calc_hash ${BASE}/slskdn-${TAG}-win-x64.zip)" >> $GITHUB_OUTPUT

      - name: Update Manifests
        run: |
          TAG=${{ steps.release.outputs.tag }}
          LINUX_SHA=${{ steps.hashes.outputs.linux_x64 }}
          WIN_SHA=${{ steps.hashes.outputs.win_x64 }}
          
          # Flatpak
          F_URL="https://github.com/snapetech/slskdn/releases/download/${TAG}/slskdn-${TAG}-linux-x64.zip"
          F_FILE="packaging/flatpak/org.slskdn.slskdn.yml"
          if [ -f "$F_FILE" ]; then
            sed -i "s|url: .*|url: $F_URL|" $F_FILE
            sed -i "s|sha256: .*|sha256: $LINUX_SHA|" $F_FILE
          fi
          
          # Snap
          S_URL="https://github.com/snapetech/slskdn/releases/download/${TAG}/slskdn-${TAG}-linux-x64.zip"
          S_FILE="packaging/snap/snapcraft.yaml"
          if [ -f "$S_FILE" ]; then
            sed -i "s|version: .*|version: '$TAG'|" $S_FILE
            sed -i "s|source: .*|source: $S_URL|" $S_FILE
            sed -i "s|source-checksum: .*|source-checksum: sha256/$LINUX_SHA|" $S_FILE
          fi
          
          # Chocolatey
          C_URL="https://github.com/snapetech/slskdn/releases/download/${TAG}/slskdn-${TAG}-win-x64.zip"
          C_NUSPEC="packaging/chocolatey/slskdn.nuspec"
          C_INSTALL="packaging/chocolatey/tools/chocolateyinstall.ps1"
          
          if [ -f "$C_NUSPEC" ]; then
            sed -i "s|<version>.*</version>|<version>$TAG</version>|" $C_NUSPEC
          fi
          if [ -f "$C_INSTALL" ]; then
            sed -i "s|\\\$url\s*=\s*\".*\"|\\\$url        = \"$C_URL\"|" $C_INSTALL
            sed -i "s|\\\$checksum\s*=\s*\".*\"|\\\$checksum   = \"$WIN_SHA\"|" $C_INSTALL
          fi
          
      - name: Commit Updates
        run: |
          git config user.name "slskdn-bot"
          git config user.email "slskdn@proton.me"
          git add -A packaging/
          git commit -m "chore: Update Flatpak, Snap, Chocolatey to ${{ steps.release.outputs.tag }}" || echo "No changes"
          git push

  build-snap:
    runs-on: ubuntu-latest
    needs: update-flatpak-snap-choco
    if: false  # Disabled until snap packaging is set up
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
      
      - name: Build Snap
        uses: snapcore/action-build@v1
        id: build
        with:
          path: packaging/snap
      
      - name: Upload Snap Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slskdn-snap
          path: ${{ steps.build.outputs.snap }}
          
      - name: Publish Snap (Conditional)
        if: env.SNAPCRAFT_STORE_CREDENTIALS != ''
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        run: |
          snapcraft upload --release=stable ${{ steps.build.outputs.snap }}

  build-chocolatey:
    runs-on: windows-latest
    needs: update-flatpak-snap-choco
    if: false  # Disabled until chocolatey packaging is set up
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          
      - name: Pack Chocolatey
        run: |
          cd packaging/chocolatey
          choco pack
          
      - name: Upload Nupkg Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slskdn-nupkg
          path: packaging/chocolatey/*.nupkg

      - name: Publish Chocolatey (Conditional)
        if: env.CHOCO_API_KEY != ''
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          cd packaging/chocolatey
          choco push --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY

  winget-pr:
    runs-on: ubuntu-latest
    needs: update-flatpak-snap-choco
    if: false  # Disabled until winget submission is set up
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Release Info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG=$(curl -s https://api.github.com/repos/snapetech/slskdn/releases/latest | jq -r .tag_name)
          else
            TAG=${{ github.event.release.tag_name }}
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
      - name: Prepare Winget Submission
        env:
          GH_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "Skipping Winget PR: WINGET_GITHUB_TOKEN not set"
            exit 0
          fi
          
          chmod +x packaging/scripts/update-winget.sh
          packaging/scripts/update-winget.sh "${{ steps.release.outputs.tag }}" "${GH_TOKEN}"
