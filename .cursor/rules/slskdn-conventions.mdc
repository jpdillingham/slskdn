---
description: slskdN coding conventions and project-specific rules
globs: ["src/**/*"]
alwaysApply: true
---

# slskdN Coding Conventions

> **Read first**: `memory-bank/decisions/adr-0002-code-patterns.md` and `adr-0003-anti-slop-rules.md`

## Copyright Headers

### New slskdN Files
```csharp
// <copyright file="FileName.cs" company="slskdN Team">
//     Copyright (c) slskdN Team. All rights reserved.
// </copyright>
```

### Existing Upstream Files
Keep original `company="slskd Team"` attribution unchanged.

### Fork-Specific Directories (Always slskdN headers)
- `Capabilities/`, `HashDb/`, `Mesh/`, `Backfill/`
- `Transfers/MultiSource/`, `Transfers/Ranking/`
- `Users/Notes/`, `Wishlist/`, `DhtRendezvous/`

## Backend (C#)

### Service Pattern
```csharp
// Interface + Implementation together
public interface IMyService { }
public class MyService : IMyService
{
    public MyService(IOptionsMonitor<Options> optionsMonitor, ILogger<MyService> logger)
    {
        OptionsMonitor = optionsMonitor;
        Logger = logger;
    }
    private IOptionsMonitor<Options> OptionsMonitor { get; }
    private ILogger Logger { get; }
}
```

### DI Registration (in Program.cs)
```csharp
services.AddSingleton<IMyService, MyService>();
// For hosted services:
services.AddHostedService(p => p.GetRequiredService<MyService>());
```

### Options Access
- **Singleton**: `IOptionsMonitor<Options>` → `OptionsMonitor.CurrentValue`
- **Scoped**: `IOptionsSnapshot<Options>`
- **Startup-only**: `OptionsAtStartup`

### Async Event Handlers (CRITICAL)
```csharp
private async void Client_Event(object s, EventArgs e)
{
    try { await DoWorkAsync(); }
    catch (Exception ex) { Logger.Error(ex, "..."); }
}
```

### Don't Do
- ❌ Factory patterns (use DI directly)
- ❌ Defensive null checks on internal code
- ❌ Try-catch that swallows errors
- ❌ Logging method entry/exit
- ❌ `async Task.FromResult()` for sync operations
- ❌ IDisposable without disposable resources

## Frontend (React/JSX)

### Component Pattern
```jsx
const MyComponent = ({ prop }) => {
  const [data, setData] = useState([]);
  const fetch = async () => {
    try {
      const response = await myLib.getAll();
      setData(response);
    } catch (error) {
      toast.error(error?.response?.data ?? error?.message ?? error);
    }
  };
  useEffect(() => { fetch(); }, []);
  return <div>...</div>;
};
```

### API Library Pattern (CRITICAL)
```javascript
export const getAll = async () => {
  const response = (await api.get('/endpoint')).data;
  return Array.isArray(response) ? response : [];  // NEVER return undefined
};
```

### Don't Do
- ❌ Class components (use function + hooks)
- ❌ PropTypes (not used in this codebase)
- ❌ TypeScript (this is plain JS)
- ❌ New state management libraries
- ❌ React 17+ features (we're on 16.8.6)

## Testing

- Tests go in `tests/slskd.Tests.Unit/`
- Use `[InlineAutoData]` for edge cases with fixed values
- Run `dotnet test` before committing

## Quick Reference

| Task | Location |
|------|----------|
| Add service | `src/slskd/MyFeature/`, register in `Program.cs` |
| Add API | `src/slskd/MyFeature/API/MyFeatureController.cs` |
| Add frontend lib | `src/web/src/lib/myFeature.js` |
| Add component | `src/web/src/components/MyFeature/` |
| Add route | `src/web/src/App.jsx` |
