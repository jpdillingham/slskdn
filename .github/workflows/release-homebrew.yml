name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Release Info
        id: release
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            LATEST_TAG=$(curl -s https://api.github.com/repos/snapetech/slskdn/releases/latest | jq -r .tag_name)
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Calculate Hashes
        id: hashes
        run: |
          TAG=${{ steps.release.outputs.tag }}
          BASE_URL="https://github.com/snapetech/slskdn/releases/download/${TAG}"
          
          calc_hash() {
            curl -sL -o tmp.zip "$1" && sha256sum tmp.zip | awk '{print $1}' && rm -f tmp.zip
          }
          
          echo "linux_x64=$(calc_hash ${BASE_URL}/slskdn-${TAG}-linux-x64.zip)" >> $GITHUB_OUTPUT
          echo "osx_arm64=$(calc_hash ${BASE_URL}/slskdn-${TAG}-osx-arm64.zip)" >> $GITHUB_OUTPUT
          echo "osx_x64=$(calc_hash ${BASE_URL}/slskdn-${TAG}-osx-x64.zip)" >> $GITHUB_OUTPUT

      - name: Update Homebrew Tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          TAG=${{ steps.release.outputs.tag }}
          BASE_URL="https://github.com/snapetech/slskdn/releases/download/${TAG}"
          
          chmod +x packaging/scripts/update-homebrew-tap.sh
          packaging/scripts/update-homebrew-tap.sh \
            "${TAG}" \
            "${BASE_URL}/slskdn-${TAG}-linux-x64.zip" \
            "${{ steps.hashes.outputs.linux_x64 }}" \
            "${BASE_URL}/slskdn-${TAG}-osx-arm64.zip" \
            "${{ steps.hashes.outputs.osx_arm64 }}" \
            "${BASE_URL}/slskdn-${TAG}-osx-x64.zip" \
            "${{ steps.hashes.outputs.osx_x64 }}" \
            "${GH_TOKEN}"
